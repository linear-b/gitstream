# Code generated by gitStream - DO NOT EDIT

image: atlassian/default-image:4

pipelines:
  # Pipelines that can only be triggered manually
  custom:
    gitstream:
      - variables:
          - name: client_payload
            description: the client payload
          - name: head_ref
            description: the head sha
          - name: debug_mode
            description: Debug mode
            default: 'true'
          - name: oauth_token
            description: token to do operations in bitbucket
          - name: full_repo
            description: workspace/repo
      - step:
          name: /:\ gitstream workflow automation
          ##### For cloud runners with IP whitelist, uncomment the section below
          # size: 4x # Required as atlassian-ip-ranges supported only on 4x or more
          # runtime:
          #   cloud:
          #     atlassian-ip-ranges: true
          ##### End of section
          #
          ##### For self-hosted runners, uncomment the section below
          # runs-on:
          #   - self.hosted # Required to indicate a self-hosted runner
          #   - cmgitstreamrunner # Custom label that must be added to your self-hosted runner
          ##### End of section
          max-time: 15
          clone:
            enabled: false
          services:
            - docker
          script:
            - git clone --shallow-since="6 months ago" --no-tags https://x-token-auth:$oauth_token@bitbucket.org/$full_repo.git gitstream/repo
            - git clone --depth=1 --no-tags https://x-token-auth:$oauth_token@bitbucket.org/$BITBUCKET_WORKSPACE/$BITBUCKET_REPO_SLUG.git gitstream/cm
            - cd gitstream/repo && git fetch origin $head_ref:$head_ref && git checkout $head_ref
            - docker pull gitstream/rules-engine:latest
            - |
              docker run -v $BITBUCKET_CLONE_DIR/gitstream:/code \
              -e RUN_ID=$BITBUCKET_BUILD_NUMBER \
              -e CLIENT_PAYLOAD="$client_payload" \
              -e DEBUG_MODE=$debug_mode gitstream/rules-engine:latest
