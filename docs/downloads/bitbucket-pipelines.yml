# Code generated by gitStream - DO NOT EDIT

image: atlassian/default-image:4

pipelines:
  # Pipelines that can only be triggered manually
  custom:
    gitstream:
      - variables:
          - name: client_payload
            description: the client payload
          - name: head_ref
            description: the head sha
          - name: base_ref
            description: The base sha
          - name: resolver_url
            description: the resolver url to pass results to
          - name: resolver_token
            description: Optional resolver token for resolver service
          - name: debug_mode
            description: Debug mode
            default: 'true'
          - name: oauth_token
            description: token to do operations in bitbucket
          - name: full_repo
            description: workspace/repo
      - step:
          name: /:\ gitstream workflow automation
          # For self-hosted runners, uncomment the runs-on section below
          # runs-on:
          #   - self.hosted # Required to indicate a self-hosted runner
          #   - cmgitstreamrunner # Custom label that must be added to your self-hosted runner
          max-time: 15
          clone:
            enabled: false
          services:
            - docker
          script:
            - git clone https://x-token-auth:$oauth_token@bitbucket.org/$full_repo.git gitstream/repo
            - git clone https://x-token-auth:$oauth_token@bitbucket.org/$BITBUCKET_WORKSPACE/$BITBUCKET_REPO_SLUG.git gitstream/cm
            - cd gitstream/repo
            - git fetch --all
            - git checkout $base_ref
            - git checkout $head_ref
            - docker pull gitstream/rules-engine:latest
            - |
              docker run -v $BITBUCKET_CLONE_DIR/gitstream:/code \
              -e HEAD_REF=$head_ref \
              -e BASE_REF=$base_ref \
              -e RUN_ID=$BITBUCKET_BUILD_NUMBER \
              -e CLIENT_PAYLOAD="$client_payload" \
              -e RULES_RESOLVER_URL=$resolver_url \
              -e RULES_RESOLVER_TOKEN=$resolver_token \
              -e DEBUG_MODE=$debug_mode gitstream/rules-engine:latest
